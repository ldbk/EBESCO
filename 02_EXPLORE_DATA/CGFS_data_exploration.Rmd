---
title: "CGFS data exploration"
date: "`r Sys.Date()`"
output: 
  rmdformats::downcute:
  highlight: zenburn
html_document :
  toc: true
toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}

# LOAD THE PACKAGES

library(ggplot2)
library(dplyr)
library(here)
library(devtools)
library(TMBhelper)
library(TMB)
library(tidyverse)
library(pak)
library(readxl)
library(readr)
library(sf)
library(sdmTMB)
library(ncdf4)
library(terra)
library(raster)
library(ggOceanMaps)
library(ggspatial) 

```

```{r message=FALSE, warning=FALSE, include=FALSE}

 # ------------------------------------------------------------------------------#
  #### 1. LOAD THE DATA #### 
  # ------------------------------------------------------------------------------#
  
  
  catch_ECGFS <- read_delim(here("01_DATA/survey/ECGFS/CGFS_1988_2024_ELFIC.V1.4_catch_2025-03-28.csv"),
                            delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)
  
  operation_ECGFS <- read_delim(here("01_DATA/survey/ECGFS/CGFS_1988_2024_ELFIC.V1.4_operation_2025-03-28.csv"),
                                delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)
  
  # others_parameters <- read_delim("01_DATA/ECGFS/CGFS_1988_2024_ELFIC.V1.4_otherParameters_2025-03-28.csv", 
  #                                 delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)
  # --> many NA for depth variable
  
  # operation_CGFS_clean <- operation_CGFS %>%
  #   filter(!is.na(startLatDD), !is.na(startLongDD))
  
  # unique(catch_CGFS$comment)
  # unique(operation_CGFS$comment)
  # unique(operation_CGFS$gear)
  # unique(catch_CGFS$stationCode)
  
  # lat_range <- range(operation_CGFS$startLatDD)
  # lon_range <- range(operation_CGFS$startLongDD)
  
  
  catch_WCGFS <-  read_delim(here("01_DATA/survey/WCGFS/WCGFS_2018_2024_ELFIC.V1.5_catch_2025-03-31.csv"), 
                             delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)
  
  operation_WCGFS <-  read_delim(here("01_DATA/survey/WCGFS/WCGFS_2018_2024_ELFIC.V1.5_operation_2025-03-31.csv"), 
                                 delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)
  
  
  
  sp_scientific = "Solea solea"
  
  # ------------------------------------------------------------------------------#
  ####  2. TRANSFORM CGFS DATA #### 
  # ------------------------------------------------------------------------------#
  
  # ------------------#
  # Eastern CGFS
  # ------------------#
  
  # select data corresponding to the species of interest
  sp_catch_ECGFS <- catch_ECGFS %>%
    dplyr::filter(scientificName == sp_scientific) %>%
    dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)
  
  
  # Combine catch, coordinates and other parameters data frames
  sp_data_ECGFS <- operation_ECGFS %>%
    left_join(sp_catch_ECGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 
  
  # Replace missing values in totalNumber and totalWeightKg with 0
  # Calculate midpoint coordinates for each haul
  # Compute density in kg/km²
  # Create a presence/absence variable (0 = absence, 1 = presence)
  sp_data_ECGFS_density <- sp_data_ECGFS %>%
    mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
           totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
    mutate(lat = (endLatDD + startLatDD)/2,
           lon = (endLongDD + startLongDD)/2) %>%
    mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
    mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))%>%
    filter(year >= 2018)
  
  
  # ------------------#
  # Western CGFS
  # ------------------#
  
  # select data corresponding to the species of interest
  sp_catch_WCGFS <- catch_WCGFS %>%
    dplyr::filter(scientificName == sp_scientific) %>%
    dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)
  
  
  # Combine catch, coordinates and other parameters data frames
  sp_data_WCGFS <- operation_WCGFS %>%
    left_join(sp_catch_WCGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 
  
  # Replace missing values in totalNumber and totalWeightKg with 0
  # Calculate midpoint coordinates for each haul
  # Compute density in kg/km²
  # Create a presence/absence variable (0 = absence, 1 = presence)
  sp_data_WCGFS_density <- sp_data_WCGFS %>%
    mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
           totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
    mutate(lat = (endLatDD + startLatDD)/2,
           lon = (endLongDD + startLongDD)/2) %>%
    mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
    mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))
  
  
  # ---------------------------------#
  # Combine Eastern & Western CGFS
  # ---------------------------------#
  
  sp_data_CGFS_density <- bind_rows(sp_data_ECGFS_density, sp_data_WCGFS_density)
  
  # range(sp_data_CGFS_density$startLatDD)
  # range(sp_data_CGFS_density$endLatDD)
  # range(sp_data_CGFS_density$startLongDD)
  # range(sp_data_CGFS_density$endLongDD)
  
    # ------------------------------------------------------------------------------#
  ####  3. ADD BATHYMETRY TO DENSITY DATA #### 
  # ------------------------------------------------------------------------------#
  
  
  # Load the bathymetry raster from a NetCDF file
  bathy_EC <- raster(here("01_DATA", "bathymetry", "EC_Bathy", "Bathy_English_Channel.nc"), varname ="depth")
  
  # Plot the cropped bathymetry
  # plot(bathy_EC, main = "Bathymetry of English Channel", col = terrain.colors(100))
  
  bathy_EC_spat <- rast(bathy_EC)
  
  # Convert the CGFS data frame to a spatial vector
  pts_CGFS <- vect(sp_data_CGFS_density,
                   geom = c("lon", "lat"),
                   crs  = crs(bathy_EC_spat))
  
  # Extract depth values from the raster at point locations
  # terra::extract() returns a data frame with ID + raster values
  depth_df <- terra::extract(bathy_EC_spat, pts_CGFS)
  
  # Add depth values to the original data frame
  # The second column of depth_df is the raster value (first is ID)
  sp_data_CGFS_density$depth <- depth_df[, 2]
  
  
  # Plot depth by location and year
  # ggplot(sp_data_CGFS_density, aes(x = lon, y = lat, color = depth)) +
  #   geom_point() +
  #   facet_wrap(~ year) +
  #   scale_color_viridis_c(option = "magma", direction = -1, name = "Depth (m)") +
  #   labs(title = "Depth (m) at CGFS stations – Eastern English Channel")
  
  #remove CGFS points out of the English Channel shapefile (depth = NA)
  CGFS_density_bathy <- sp_data_CGFS_density %>%
    filter(!is.na(depth))
  
  
  
  # ------------------------------------------------------------------------------#
  #### 4. ADD UTM #### 
  # ------------------------------------------------------------------------------#
  
  utm_crs_used <- get_crs(CGFS_density_bathy, c("lon", "lat"))
  
  # Add UTM (Universal Transverse Mercator) coordinates to a data frame
  # This is useful since geostatistical modeling should generally be performed in an equal-distance projection.
  data_CGFS_crs <- add_utm_columns(CGFS_density_bathy, 
                                   ll_names = c("lon", "lat"),   # longitude and latitude column names
                                   ll_crs = 4326,                # CRS = coordinates reference system --> 4326 = WGS84 (most commun)
                                   utm_names = c("X", "Y"),      # output column names for the UTM columns
                                   utm_crs = utm_crs_used,       # output CRS value for the UTM zone
                                   units = "km")                 # UTM units
  
  

  EC_shp <- vect(here("01_DATA", "shapefiles", "English_Channel", "English_Channel.shp"))
  EC_sf <- st_as_sf(EC_shp) %>% st_transform(4326)


```


# *Solea solea* density 

```{r echo=FALSE, message=FALSE, warning=FALSE}

basemap(data = EC_sf) +   
  geom_sf(data = EC_sf, fill = NA) +        
  geom_spatial_point(data = data_CGFS_crs, 
                     aes(x = lon, y = lat, 
                         color = factor(presence_absence), 
                         size  = densityKgKm2), 
                     alpha = 0.6) +
  scale_color_manual(values = c("0" = "red", "1" = "blue"), 
                     labels = c("Absence", "Présence"), 
                     name   ="Présence") +
  scale_size_continuous(name ="Densité (kg/km²)") +
  facet_wrap(~ year) +
  ggtitle(bquote("Distribution spatiale de la densité de " * italic(.(sp_scientific)) * " entre 2018 et 2024 (CGFS)"))+
    labs(x="", y="")
```

\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(data_CGFS_crs, aes(x = totalNumber, y = totalWeightKg)) +
  geom_point()+
  geom_smooth(method = "lm")+
  ggtitle(bquote("Relationship between abundance and biomass of " * italic(.(sp_scientific))))+
  labs(x = "Total number of individuals", y = "Total weight (kg)", subtitle = "Each point represents a haul")

```
<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(data_CGFS_crs, aes(x = totalNumber, y = totalWeightKg)) +
  geom_point() +
  geom_smooth(method = "lm")+
  facet_wrap(~year, scales = "free") +
  ggtitle(bquote("Relationship between abundance and biomass of " * italic(.(sp_scientific)) * " by year"))+
  labs(x = "Total number of individuals", y = "Total weight (kg)", subtitle = "Each point represents a haul")

```

<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(data_CGFS_crs, aes(x = factor(year), y = densityKgKm2)) +
  geom_point()+
  theme_minimal() +
  labs(x = "Years", y = "Density (kg/km²)")+
  ggtitle(bquote("Density of " * italic(.(sp_scientific)) * " per haul across years"))
```
<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(data_CGFS_crs, aes(x = factor(year), y = densityKgKm2)) +
  geom_boxplot(outlier.alpha = 0.4)+
  geom_violin()+
  theme_minimal() +
  labs(x = "Years", y = "Density (kg/km²)")+
  ggtitle(bquote("Density of " * italic(.(sp_scientific)) * " per haul across years"))

```
<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

ggplot(subset(data_CGFS_crs, densityKgKm2 > 0), aes(x = factor(year), y = densityKgKm2)) +
  geom_boxplot(outlier.alpha = 0.4)+
  geom_violin(alpha=0.4) +
  theme_minimal() +
  labs(x = "Years", y = "Density (kg/km², only >0)") +
  ggtitle(bquote("Density of " * italic(.(sp_scientific)) * " per haul across years (excluding zeros)"))


```

<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Histogram of density by year

ggplot(data_CGFS_crs, aes(x = densityKgKm2)) +
  geom_histogram()+
  facet_wrap(~year)+
  labs(x = "Density (kg/km²)", y= "Number of hauls") +
  theme_minimal()+
  theme(strip.background = element_rect(color = "black", fill = "grey90"))+
  ggtitle(bquote("Frequency distribution of " * italic(.(sp_scientific)) * " density per year"))

```

<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Column plot of total density by year

ggplot(data_CGFS_crs, aes(x = factor(year), y=densityKgKm2)) + 
  geom_col() +
  labs(y = "Density (kg/km²)", x = "Years") +
  ggtitle(bquote("Total density of " * italic(.(sp_scientific)) * " from CGFS hauls per year"))+
  theme_minimal()

```



# *Dicentrarchus labrax* density

```{r message=FALSE, warning=FALSE, include=FALSE}


  sp_scientific = "Dicentrarchus labrax"
  
  # ------------------------------------------------------------------------------#
  ####  2. TRANSFORM CGFS DATA #### 
  # ------------------------------------------------------------------------------#
  
  # ------------------#
  # Eastern CGFS
  # ------------------#
  
  # select data corresponding to the species of interest
  sp_catch_ECGFS <- catch_ECGFS %>%
    dplyr::filter(scientificName == sp_scientific) %>%
    dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)
  
  
  # Combine catch, coordinates and other parameters data frames
  sp_data_ECGFS <- operation_ECGFS %>%
    left_join(sp_catch_ECGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 
  
  # Replace missing values in totalNumber and totalWeightKg with 0
  # Calculate midpoint coordinates for each haul
  # Compute density in kg/km²
  # Create a presence/absence variable (0 = absence, 1 = presence)
  sp_data_ECGFS_density <- sp_data_ECGFS %>%
    mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
           totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
    mutate(lat = (endLatDD + startLatDD)/2,
           lon = (endLongDD + startLongDD)/2) %>%
    mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
    mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))%>%
    filter(year >= 2018)
  
  
  # ------------------#
  # Western CGFS
  # ------------------#
  
  # select data corresponding to the species of interest
  sp_catch_WCGFS <- catch_WCGFS %>%
    dplyr::filter(scientificName == sp_scientific) %>%
    dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)
  
  
  # Combine catch, coordinates and other parameters data frames
  sp_data_WCGFS <- operation_WCGFS %>%
    left_join(sp_catch_WCGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 
  
  # Replace missing values in totalNumber and totalWeightKg with 0
  # Calculate midpoint coordinates for each haul
  # Compute density in kg/km²
  # Create a presence/absence variable (0 = absence, 1 = presence)
  sp_data_WCGFS_density <- sp_data_WCGFS %>%
    mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
           totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
    mutate(lat = (endLatDD + startLatDD)/2,
           lon = (endLongDD + startLongDD)/2) %>%
    mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
    mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))
  
  
  # ---------------------------------#
  # Combine Eastern & Western CGFS
  # ---------------------------------#
  
  sp_data_CGFS_density <- bind_rows(sp_data_ECGFS_density, sp_data_WCGFS_density)
  
  # range(sp_data_CGFS_density$startLatDD)
  # range(sp_data_CGFS_density$endLatDD)
  # range(sp_data_CGFS_density$startLongDD)
  # range(sp_data_CGFS_density$endLongDD)
  
    # ------------------------------------------------------------------------------#
  ####  3. ADD BATHYMETRY TO DENSITY DATA #### 
  # ------------------------------------------------------------------------------#
  
  
  # Load the bathymetry raster from a NetCDF file
  bathy_EC <- raster(here("01_DATA", "bathymetry", "EC_Bathy", "Bathy_English_Channel.nc"), varname ="depth")
  
  # Plot the cropped bathymetry
  # plot(bathy_EC, main = "Bathymetry of English Channel", col = terrain.colors(100))
  
  bathy_EC_spat <- rast(bathy_EC)
  
  # Convert the CGFS data frame to a spatial vector
  pts_CGFS <- vect(sp_data_CGFS_density,
                   geom = c("lon", "lat"),
                   crs  = crs(bathy_EC_spat))
  
  # Extract depth values from the raster at point locations
  # terra::extract() returns a data frame with ID + raster values
  depth_df <- terra::extract(bathy_EC_spat, pts_CGFS)
  
  # Add depth values to the original data frame
  # The second column of depth_df is the raster value (first is ID)
  sp_data_CGFS_density$depth <- depth_df[, 2]
  
  
  # Plot depth by location and year
  # ggplot(sp_data_CGFS_density, aes(x = lon, y = lat, color = depth)) +
  #   geom_point() +
  #   facet_wrap(~ year) +
  #   scale_color_viridis_c(option = "magma", direction = -1, name = "Depth (m)") +
  #   labs(title = "Depth (m) at CGFS stations – Eastern English Channel")
  
  #remove CGFS points out of the English Channel shapefile (depth = NA)
  CGFS_density_bathy <- sp_data_CGFS_density %>%
    filter(!is.na(depth))
  
  
  
  # ------------------------------------------------------------------------------#
  #### 4. ADD UTM #### 
  # ------------------------------------------------------------------------------#
  
  utm_crs_used <- get_crs(CGFS_density_bathy, c("lon", "lat"))
  
  # Add UTM (Universal Transverse Mercator) coordinates to a data frame
  # This is useful since geostatistical modeling should generally be performed in an equal-distance projection.
  data_CGFS_crs <- add_utm_columns(CGFS_density_bathy, 
                                   ll_names = c("lon", "lat"),   # longitude and latitude column names
                                   ll_crs = 4326,                # CRS = coordinates reference system --> 4326 = WGS84 (most commun)
                                   utm_names = c("X", "Y"),      # output column names for the UTM columns
                                   utm_crs = utm_crs_used,       # output CRS value for the UTM zone
                                   units = "km")                 # UTM units
  
  

  EC_shp <- vect(here("01_DATA", "shapefiles", "English_Channel", "English_Channel.shp"))
  EC_sf <- st_as_sf(EC_shp) %>% st_transform(4326)


```


```{r echo=FALSE, message=FALSE, warning=FALSE}

basemap(data = EC_sf) +   
  geom_sf(data = EC_sf, fill = NA) +        
  geom_spatial_point(data = data_CGFS_crs, 
                     aes(x = lon, y = lat, 
                         color = factor(presence_absence), 
                         size  = densityKgKm2), 
                     alpha = 0.6) +
  scale_color_manual(values = c("0" = "red", "1" = "blue"), 
                     labels = c("Absence", "Présence"), 
                     name   ="Présence") +
  scale_size_continuous(name ="Densité (kg/km²)") +
  facet_wrap(~ year) +
  ggtitle(bquote("Distribution spatiale de la densité de " * italic(.(sp_scientific)) * " entre 2018 et 2024 (CGFS)"))+
    labs(x="", y="")
```

\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(data_CGFS_crs, aes(x = totalNumber, y = totalWeightKg)) +
  geom_point()+
  geom_smooth(method = "lm")+
  ggtitle(bquote("Relationship between abundance and biomass of " * italic(.(sp_scientific))))+
  labs(x = "Total number of individuals", y = "Total weight (kg)", subtitle = "Each point represents a haul")

```
<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(data_CGFS_crs, aes(x = totalNumber, y = totalWeightKg)) +
  geom_point() +
  geom_smooth(method = "lm")+
  facet_wrap(~year, scales = "free") +
  ggtitle(bquote("Relationship between abundance and biomass of " * italic(.(sp_scientific)) * " by year"))+
  labs(x = "Total number of individuals", y = "Total weight (kg)", subtitle = "Each point represents a haul")

```

<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(data_CGFS_crs, aes(x = factor(year), y = densityKgKm2)) +
  geom_point()+
  theme_minimal() +
  labs(x = "Years", y = "Density (kg/km²)")+
  ggtitle(bquote("Density of " * italic(.(sp_scientific)) * " per haul across years"))
```
<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(data_CGFS_crs, aes(x = factor(year), y = densityKgKm2)) +
  geom_boxplot(outlier.alpha = 0.4)+
  geom_violin()+
  theme_minimal() +
  labs(x = "Years", y = "Density (kg/km²)")+
  ggtitle(bquote("Density of " * italic(.(sp_scientific)) * " per haul across years"))

```
<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

ggplot(subset(data_CGFS_crs, densityKgKm2 > 0), aes(x = factor(year), y = densityKgKm2)) +
  geom_boxplot(outlier.alpha = 0.4)+
  geom_violin(alpha=0.4) +
  theme_minimal() +
  labs(x = "Years", y = "Density (kg/km², only >0)") +
  ggtitle(bquote("Density of " * italic(.(sp_scientific)) * " per haul across years (excluding zeros)"))


```

<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Histogram of density by year

ggplot(data_CGFS_crs, aes(x = densityKgKm2)) +
  geom_histogram()+
  facet_wrap(~year)+
  labs(x = "Density (kg/km²)", y= "Number of hauls") +
  theme_minimal()+
  theme(strip.background = element_rect(color = "black", fill = "grey90"))+
  ggtitle(bquote("Frequency distribution of " * italic(.(sp_scientific)) * " density per year"))

```

<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Column plot of total density by year

ggplot(data_CGFS_crs, aes(x = factor(year), y=densityKgKm2)) + 
  geom_col() +
  labs(y = "Density (kg/km²)", x = "Years") +
  ggtitle(bquote("Total density of " * italic(.(sp_scientific)) * " from CGFS hauls per year"))+
  theme_minimal()

```


# Bathymetry of English Channel


```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Plot the cropped bathymetry
plot(bathy_EC, main = "Bathymetry of English Channel", col = terrain.colors(100))


```

<br>
<br>
\vspace{2cm}

# Bathymetry at CGFS stations


```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}


# Plot depth by location and year

basemap(data = EC_sf) +   
  geom_sf(data = EC_sf, fill = NA) +        
  geom_spatial_point(data = data_CGFS_crs, 
                     aes(x = lon, y = lat, color = depth), alpha = 0.8) +
  scale_color_viridis_c(option = "magma", direction = -1, name = "Profondeur (m)") +
  facet_wrap(~ year) +
  labs(title = "Profondeur aux stations CGFS", x = "", y = "") 


```
<br>
<br>
\vspace{2cm}

# Bathymetry and sole presence

```{r message=FALSE, warning=FALSE, include=FALSE}


  sp_scientific = "Solea solea"
  
  # ------------------------------------------------------------------------------#
  ####  2. TRANSFORM CGFS DATA #### 
  # ------------------------------------------------------------------------------#
  
  # ------------------#
  # Eastern CGFS
  # ------------------#
  
  # select data corresponding to the species of interest
  sp_catch_ECGFS <- catch_ECGFS %>%
    dplyr::filter(scientificName == sp_scientific) %>%
    dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)
  
  
  # Combine catch, coordinates and other parameters data frames
  sp_data_ECGFS <- operation_ECGFS %>%
    left_join(sp_catch_ECGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 
  
  # Replace missing values in totalNumber and totalWeightKg with 0
  # Calculate midpoint coordinates for each haul
  # Compute density in kg/km²
  # Create a presence/absence variable (0 = absence, 1 = presence)
  sp_data_ECGFS_density <- sp_data_ECGFS %>%
    mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
           totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
    mutate(lat = (endLatDD + startLatDD)/2,
           lon = (endLongDD + startLongDD)/2) %>%
    mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
    mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))%>%
    filter(year >= 2018)
  
  
  # ------------------#
  # Western CGFS
  # ------------------#
  
  # select data corresponding to the species of interest
  sp_catch_WCGFS <- catch_WCGFS %>%
    dplyr::filter(scientificName == sp_scientific) %>%
    dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)
  
  
  # Combine catch, coordinates and other parameters data frames
  sp_data_WCGFS <- operation_WCGFS %>%
    left_join(sp_catch_WCGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 
  
  # Replace missing values in totalNumber and totalWeightKg with 0
  # Calculate midpoint coordinates for each haul
  # Compute density in kg/km²
  # Create a presence/absence variable (0 = absence, 1 = presence)
  sp_data_WCGFS_density <- sp_data_WCGFS %>%
    mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
           totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
    mutate(lat = (endLatDD + startLatDD)/2,
           lon = (endLongDD + startLongDD)/2) %>%
    mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
    mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))
  
  
  # ---------------------------------#
  # Combine Eastern & Western CGFS
  # ---------------------------------#
  
  sp_data_CGFS_density <- bind_rows(sp_data_ECGFS_density, sp_data_WCGFS_density)
  
  # range(sp_data_CGFS_density$startLatDD)
  # range(sp_data_CGFS_density$endLatDD)
  # range(sp_data_CGFS_density$startLongDD)
  # range(sp_data_CGFS_density$endLongDD)
  
    # ------------------------------------------------------------------------------#
  ####  3. ADD BATHYMETRY TO DENSITY DATA #### 
  # ------------------------------------------------------------------------------#
  
  
  # Load the bathymetry raster from a NetCDF file
  bathy_EC <- raster(here("01_DATA", "bathymetry", "EC_Bathy", "Bathy_English_Channel.nc"), varname ="depth")
  
  # Plot the cropped bathymetry
  # plot(bathy_EC, main = "Bathymetry of English Channel", col = terrain.colors(100))
  
  bathy_EC_spat <- rast(bathy_EC)
  
  # Convert the CGFS data frame to a spatial vector
  pts_CGFS <- vect(sp_data_CGFS_density,
                   geom = c("lon", "lat"),
                   crs  = crs(bathy_EC_spat))
  
  # Extract depth values from the raster at point locations
  # terra::extract() returns a data frame with ID + raster values
  depth_df <- terra::extract(bathy_EC_spat, pts_CGFS)
  
  # Add depth values to the original data frame
  # The second column of depth_df is the raster value (first is ID)
  sp_data_CGFS_density$depth <- depth_df[, 2]
  
  
  # Plot depth by location and year
  # ggplot(sp_data_CGFS_density, aes(x = lon, y = lat, color = depth)) +
  #   geom_point() +
  #   facet_wrap(~ year) +
  #   scale_color_viridis_c(option = "magma", direction = -1, name = "Depth (m)") +
  #   labs(title = "Depth (m) at CGFS stations – Eastern English Channel")
  
  #remove CGFS points out of the English Channel shapefile (depth = NA)
  CGFS_density_bathy <- sp_data_CGFS_density %>%
    filter(!is.na(depth))
  
  
  
  # ------------------------------------------------------------------------------#
  #### 4. ADD UTM #### 
  # ------------------------------------------------------------------------------#
  
  utm_crs_used <- get_crs(CGFS_density_bathy, c("lon", "lat"))
  
  # Add UTM (Universal Transverse Mercator) coordinates to a data frame
  # This is useful since geostatistical modeling should generally be performed in an equal-distance projection.
  data_CGFS_crs <- add_utm_columns(CGFS_density_bathy, 
                                   ll_names = c("lon", "lat"),   # longitude and latitude column names
                                   ll_crs = 4326,                # CRS = coordinates reference system --> 4326 = WGS84 (most commun)
                                   utm_names = c("X", "Y"),      # output column names for the UTM columns
                                   utm_crs = utm_crs_used,       # output CRS value for the UTM zone
                                   units = "km")                 # UTM units
  
  

  EC_shp <- vect(here("01_DATA", "shapefiles", "English_Channel", "English_Channel.shp"))
  EC_sf <- st_as_sf(EC_shp) %>% st_transform(4326)


```

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}


data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(x = presence_absence, y = -depth)) +
  geom_point() +
  facet_wrap(~ year) +
  labs(y = "Absence/Presence", x = "Depth (m)") +
  ggtitle(bquote("Effect of depth on " * italic(.(sp_scientific)) * " presence"))

```
<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(x =presence_absence, y = -depth)) +
  geom_violin() +
  geom_boxplot(width = 0.2) +
  labs(x = "Absence/Presence",  y = "Depth (m)")+
  ggtitle(bquote("Comparison of depth between " * italic(.(sp_scientific)) * " absence and presence"))+
  theme_minimal()

```

<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}


data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(y = -depth, fill = presence_absence)) +
  geom_histogram(binwidth = 10, position = "stack", color ="gray") +
  scale_y_continuous(breaks = seq(-5,-125,-10), minor_breaks = FALSE)+
  labs(y = "Depth (m)", x = "Number of hauls", fill = "Presence/Absence") +
  ggtitle(bquote("Distribution of " * italic(.(sp_scientific)) * " presence and absence per 10m depth bin"))+
  theme_minimal()

```
<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(y = -depth, fill = presence_absence)) +
  geom_histogram(binwidth = 10, position = "fill", color = "gray") +  # position="fill" = proportion
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_continuous(breaks = seq(-5,-125,-10), minor_breaks = FALSE)+
  labs(y = "Depth (m)",  x = "Proportion",  fill = "Presence/Absence")+
  ggtitle(bquote("Pourcentage of " * italic(.(sp_scientific)) * " presence and absence per 10m depth bin"))+
  theme_minimal()
```

<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(y = -depth, fill = presence_absence)) +
  geom_histogram(binwidth = 10, position = "fill", color = "gray") +  # position="fill" = proportion
  facet_wrap(~year)+
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_continuous(breaks = seq(-5,-125,-10), minor_break=FALSE)+
  labs(y = "Depth (m)",  x = "Proportion",  fill = "Presence/Absence")+
  ggtitle(bquote("Proportion of " * italic(.(sp_scientific)) * " presence and absence per 10m depth bin per year"))+
  theme_minimal()
```
<br>
<br>
\vspace{2cm}



# Bathymetry and sole biomass/density

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>% 
  filter(totalWeightKg > 0)%>%
ggplot(aes(x = totalWeightKg, y = -depth)) +
  geom_point() +
  labs(x = "total weight per haul (kg)", y = "depth") +
  ggtitle(bquote("Distribution of " * italic(.(sp_scientific)) * " catch weight across depth (excluding 0)"))

```
<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>% 
  filter(totalWeightKg > 0)%>%
ggplot(aes(x = totalWeightKg, y = -depth)) +
  geom_point() +
  facet_wrap(~ year, scales = "free_x") +
  labs(x = "total weight per haul (kg)", y = "depth")+
  ggtitle(bquote("Distribution of " * italic(.(sp_scientific)) * " catch weight per year across depth (excluding 0)"))


```
<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>% 
  filter(densityKgKm2 > 0)%>%
ggplot(aes(x = densityKgKm2, y = -depth)) +
  geom_point()+
    labs(x = "density (kg/km²)", y = "depth", subtitle = "1 point = 1 haul")+
      ggtitle(bquote("Distribution of " * italic(.(sp_scientific)) * " density across depth per year (excluding 0)"))

```
<br>
<br>
\vspace{2cm}



# Bathymetry and seabass presence

```{r message=FALSE, warning=FALSE, include=FALSE}


  sp_scientific = "Dicentrarchus labrax"
  
  # ------------------------------------------------------------------------------#
  ####  2. TRANSFORM CGFS DATA #### 
  # ------------------------------------------------------------------------------#
  
  # ------------------#
  # Eastern CGFS
  # ------------------#
  
  # select data corresponding to the species of interest
  sp_catch_ECGFS <- catch_ECGFS %>%
    dplyr::filter(scientificName == sp_scientific) %>%
    dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)
  
  
  # Combine catch, coordinates and other parameters data frames
  sp_data_ECGFS <- operation_ECGFS %>%
    left_join(sp_catch_ECGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 
  
  # Replace missing values in totalNumber and totalWeightKg with 0
  # Calculate midpoint coordinates for each haul
  # Compute density in kg/km²
  # Create a presence/absence variable (0 = absence, 1 = presence)
  sp_data_ECGFS_density <- sp_data_ECGFS %>%
    mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
           totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
    mutate(lat = (endLatDD + startLatDD)/2,
           lon = (endLongDD + startLongDD)/2) %>%
    mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
    mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))%>%
    filter(year >= 2018)
  
  
  # ------------------#
  # Western CGFS
  # ------------------#
  
  # select data corresponding to the species of interest
  sp_catch_WCGFS <- catch_WCGFS %>%
    dplyr::filter(scientificName == sp_scientific) %>%
    dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)
  
  
  # Combine catch, coordinates and other parameters data frames
  sp_data_WCGFS <- operation_WCGFS %>%
    left_join(sp_catch_WCGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 
  
  # Replace missing values in totalNumber and totalWeightKg with 0
  # Calculate midpoint coordinates for each haul
  # Compute density in kg/km²
  # Create a presence/absence variable (0 = absence, 1 = presence)
  sp_data_WCGFS_density <- sp_data_WCGFS %>%
    mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
           totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
    mutate(lat = (endLatDD + startLatDD)/2,
           lon = (endLongDD + startLongDD)/2) %>%
    mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
    mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))
  
  
  # ---------------------------------#
  # Combine Eastern & Western CGFS
  # ---------------------------------#
  
  sp_data_CGFS_density <- bind_rows(sp_data_ECGFS_density, sp_data_WCGFS_density)
  
  # range(sp_data_CGFS_density$startLatDD)
  # range(sp_data_CGFS_density$endLatDD)
  # range(sp_data_CGFS_density$startLongDD)
  # range(sp_data_CGFS_density$endLongDD)
  
    # ------------------------------------------------------------------------------#
  ####  3. ADD BATHYMETRY TO DENSITY DATA #### 
  # ------------------------------------------------------------------------------#
  
  
  # Load the bathymetry raster from a NetCDF file
  bathy_EC <- raster(here("01_DATA", "bathymetry", "EC_Bathy", "Bathy_English_Channel.nc"), varname ="depth")
  
  # Plot the cropped bathymetry
  # plot(bathy_EC, main = "Bathymetry of English Channel", col = terrain.colors(100))
  
  bathy_EC_spat <- rast(bathy_EC)
  
  # Convert the CGFS data frame to a spatial vector
  pts_CGFS <- vect(sp_data_CGFS_density,
                   geom = c("lon", "lat"),
                   crs  = crs(bathy_EC_spat))
  
  # Extract depth values from the raster at point locations
  # terra::extract() returns a data frame with ID + raster values
  depth_df <- terra::extract(bathy_EC_spat, pts_CGFS)
  
  # Add depth values to the original data frame
  # The second column of depth_df is the raster value (first is ID)
  sp_data_CGFS_density$depth <- depth_df[, 2]
  
  
  # Plot depth by location and year
  # ggplot(sp_data_CGFS_density, aes(x = lon, y = lat, color = depth)) +
  #   geom_point() +
  #   facet_wrap(~ year) +
  #   scale_color_viridis_c(option = "magma", direction = -1, name = "Depth (m)") +
  #   labs(title = "Depth (m) at CGFS stations – Eastern English Channel")
  
  #remove CGFS points out of the English Channel shapefile (depth = NA)
  CGFS_density_bathy <- sp_data_CGFS_density %>%
    filter(!is.na(depth))
  
  
  
  # ------------------------------------------------------------------------------#
  #### 4. ADD UTM #### 
  # ------------------------------------------------------------------------------#
  
  utm_crs_used <- get_crs(CGFS_density_bathy, c("lon", "lat"))
  
  # Add UTM (Universal Transverse Mercator) coordinates to a data frame
  # This is useful since geostatistical modeling should generally be performed in an equal-distance projection.
  data_CGFS_crs <- add_utm_columns(CGFS_density_bathy, 
                                   ll_names = c("lon", "lat"),   # longitude and latitude column names
                                   ll_crs = 4326,                # CRS = coordinates reference system --> 4326 = WGS84 (most commun)
                                   utm_names = c("X", "Y"),      # output column names for the UTM columns
                                   utm_crs = utm_crs_used,       # output CRS value for the UTM zone
                                   units = "km")                 # UTM units
  
  

  EC_shp <- vect(here("01_DATA", "shapefiles", "English_Channel", "English_Channel.shp"))
  EC_sf <- st_as_sf(EC_shp) %>% st_transform(4326)


```

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}


data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(x = presence_absence, y = -depth)) +
  geom_point() +
  facet_wrap(~ year) +
  labs(y = "Absence/Presence", x = "Depth (m)") +
  ggtitle(bquote("Effect of depth on " * italic(.(sp_scientific)) * " presence"))

```
<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(x =presence_absence, y = -depth)) +
  geom_violin() +
  geom_boxplot(width = 0.2) +
  labs(x = "Absence/Presence",  y = "Depth (m)")+
  ggtitle(bquote("Comparison of depth between " * italic(.(sp_scientific)) * " absence and presence"))+
  theme_minimal()

```

<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}


data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(y = -depth, fill = presence_absence)) +
  geom_histogram(binwidth = 10, position = "stack", color ="gray") +
  scale_y_continuous(breaks = seq(-5,-125,-10), minor_breaks = FALSE)+
  labs(y = "Depth (m)", x = "Number of hauls", fill = "Presence/Absence") +
  ggtitle(bquote("Distribution of " * italic(.(sp_scientific)) * " presence and absence per 10m depth bin"))+
  theme_minimal()

```
<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(y = -depth, fill = presence_absence)) +
  geom_histogram(binwidth = 10, position = "fill", color = "gray") +  # position="fill" = proportion
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_continuous(breaks = seq(-5,-125,-10), minor_breaks = FALSE)+
  labs(y = "Depth (m)",  x = "Proportion",  fill = "Presence/Absence")+
  ggtitle(bquote("Proportion of " * italic(.(sp_scientific)) * " presence and absence per 10m depth bin"))+
  theme_minimal()
```

<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>%
  mutate(presence_absence = factor(presence_absence, 
                                   levels = c(0, 1),  
                                   labels = c("Absence", "Presence"))) %>%
  ggplot(aes(y = -depth, fill = presence_absence)) +
  geom_histogram(binwidth = 10, position = "fill", color = "gray") +  # position="fill" = proportion
  facet_wrap(~year)+
  scale_x_continuous(labels = scales::percent_format()) +
  scale_y_continuous(breaks = seq(-5,-125,-10), minor_break=FALSE)+
  labs(y = "Depth (m)",  x = "Proportion",  fill = "Presence/Absence")+
  ggtitle(bquote("Proportion of " * italic(.(sp_scientific)) * " presence and absence per 10m depth bin per year"))+
  theme_minimal()
```
<br>
<br>
\vspace{2cm}



# Bathymetry and seabass biomass/density

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>% 
  filter(totalWeightKg > 0)%>%
ggplot(aes(x = totalWeightKg, y = -depth)) +
  geom_point() +
  labs(x = "total weight per haul (kg)", y = "depth") +
  ggtitle(bquote("Distribution of " * italic(.(sp_scientific)) * " catch weight across depth (excluding 0)"))

```
<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>% 
  filter(totalWeightKg > 0)%>%
ggplot(aes(x = totalWeightKg, y = -depth)) +
  geom_point() +
  facet_wrap(~ year, scales = "free_x") +
  labs(x = "total weight per haul (kg)", y = "depth")+
  ggtitle(bquote("Distribution of " * italic(.(sp_scientific)) * " catch weight per year across depth (excluding 0)"))


```
<br>
<br>
\vspace{2cm}
```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

data_CGFS_crs %>% 
  filter(densityKgKm2 > 0)%>%
ggplot(aes(x = densityKgKm2, y = -depth)) +
  geom_point()+
    labs(x = "density (kg/km²)", y = "depth", subtitle = "1 point = 1 haul")+
      ggtitle(bquote("Distribution of " * italic(.(sp_scientific)) * " density across depth per year (excluding 0)"))

```
<br>
<br>
\vspace{2cm}
