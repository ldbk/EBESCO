---
title: "CGFS data exploration"
output:
  pdf_document: default
  html_document:
    df_print: paged
date: "2025-11-12"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message=FALSE, warning=FALSE, include=FALSE}

# LOAD THE PACKAGES

library(ggplot2)
library(dplyr)
library(here)
library(devtools)
library(TMBhelper)
library(TMB)
library(tidyverse)
library(pak)
library(readxl)
library(readr)
library(sf)
library(sdmTMB)
library(ncdf4)
library(terra)
library(raster)
library(ggOceanMaps)
library(ggspatial) 

```

```{r message=FALSE, warning=FALSE, include=FALSE}

# LOAD THE DATA

catch_CGFS <- read_delim(here("01_DATA", "CGFS-ELFIC-1988-2024-SEANOE", "CGFS_1988_2024_ELFIC.V1.4_catch_2025-03-28.csv"), delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)

operation_CGFS <- read_delim(here("01_DATA", "CGFS-ELFIC-1988-2024-SEANOE", "CGFS_1988_2024_ELFIC.V1.4_operation_2025-03-28.csv"), delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)

# others_parameters <- read_delim(here("01_DATA", "CGFS-ELFIC-1988-2024-SEANOE", "CGFS_1988_2024_ELFIC.V1.4_otherParameters_2025-03-28.csv"), delim = ";", escape_double = FALSE, trim_ws = TRUE, show_col_types = FALSE)
# --> many NA for depth variable

# operation_CGFS_clean <- operation_CGFS %>%
#   filter(!is.na(startLatDD), !is.na(startLongDD))

# unique(catch_CGFS$comment)
# unique(operation_CGFS$comment)
# unique(operation_CGFS$gear)
# unique(catch_CGFS$stationCode)

# lat_range <- range(operation_CGFS$startLatDD)
# lon_range <- range(operation_CGFS$startLongDD)

```


## SAMPLING EFFORT  

### Overview of Sampling Locations<br>  

#### All Survey Years (1988-2024)<br>  


```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

bbox <- c(-1.9, 2.5, 49.2, 51.4)   # Eastern English Channel coordinates

```

```{r echo=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

basemap(limits = bbox ) +
  geom_spatial_point(data = operation_CGFS, 
                     aes(x = startLongDD, y = startLatDD), color = "blue")+
  facet_wrap(~ year)+
  ggtitle("Spatial distribution of haul start positions by year from the CGFS campaign")+
  labs(x="Longitude", y="Latitude")

```
```{r echo=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

basemap(limits = bbox ) +
  geom_spatial_point(data = operation_CGFS, 
                     aes(x = startLongDD, y = startLatDD, color = factor(year)), 
                     size = 2, alpha = 0.4)+
  ggtitle("Spatial distribution of haul start positions by year from the CGFS campaign")+
  labs(x="Longitude", y="Latitude", color="Years")

```
No sampling occurred beyond 51°N after 2014.<br>  
October 2015: CGFS survey conducted on the R/V Thalassa — station layout adjusted according to the vessel’s draft, reducing the number of stations in the eastern English Channel from 110 to 74.<br>  
September / October 2020: No authorization granted for operations in UK waters.<br>  
Historical Overview of the Sampling Protocol : https://sextant.ifremer.fr/record/209fbac0-afce-441c-8844-558796a6b873/   

<br>
<br>
<br>
\vspace{1cm}


#### Since 2015  


```{r echo=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

operation_CGFS_2015 <- operation_CGFS %>%   filter(year >= 2015)

basemap(limits = bbox ) +
  geom_spatial_point(data = operation_CGFS_2015, 
                     aes(x = startLongDD, y = startLatDD), color = "blue")+
  facet_wrap(~ year)+
  ggtitle("Spatial distribution of haul start positions by year from the CGFS campaign since 2015")+
  labs(x="Longitude", y="Latitude")
```
\vspace{0.5cm} 

```{r echo=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

basemap(limits = bbox ) +
  geom_spatial_point(data = operation_CGFS_2015, 
                     aes(x = startLongDD, y = startLatDD, color = factor(year)), size = 2, alpha = 0.6)+
  ggtitle("Spatial distribution of haul start positions by year from the CGFS campaign since 2015")+
  labs(x="Longitude", y="Latitude", color="Years")

```
\vspace{3cm}
<br>
<br>
<br>

## *Solea solea* density since 2015  

```{r message=FALSE, warning=FALSE, include=FALSE}

# select data corresponding to the species of interest
sp_catch_CGFS <- catch_CGFS %>%
  dplyr::filter(scientificName == "Solea solea") %>%
  dplyr::select(serie, year, stationCode, operationID, haulID, totalNumber, totalWeightKg)

# Combine catch, coordinates and other parameters data frames
sp_data_CGFS <- operation_CGFS %>%
  left_join(sp_catch_CGFS, by = c("serie", "year", "stationCode", "operationID", "haulID")) 

# Replace missing values in totalNumber and totalWeightKg with 0
# Calculate midpoint coordinates for each haul
# Compute density in kg/km²
# Create a presence/absence variable (0 = absence, 1 = presence)
# Keep only data from 2015 onwards
sp_data_CGFS_density <- sp_data_CGFS %>%
  mutate(totalNumber = ifelse(is.na(totalNumber), 0, totalNumber),
         totalWeightKg = ifelse(is.na(totalWeightKg), 0, totalWeightKg)) %>%
  mutate(lat = (endLatDD + startLatDD)/2,
         lon = (endLongDD + startLongDD)/2) %>%
  mutate(densityKgKm2 = totalWeightKg/sweptAreaKm2) %>%
  mutate(presence_absence = ifelse(totalWeightKg == 0, 0, 1))%>%
  filter(year >= 2015)

```
```{r echo=FALSE, fig.height=8, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Map of Solea solea density by year
basemap(limits = bbox ) +
  geom_spatial_point(data = sp_data_CGFS_density, 
                     aes(x = startLongDD, y = startLatDD, color = factor(presence_absence), 
                         size = densityKgKm2), 
                     alpha = 0.6)+
  scale_color_manual(values = c("0" = "red", "1" = "blue"), labels = c("Absence", "Presence"), name ="Presence") +
  scale_size_continuous(name ="Density (kg/km²)") +
  facet_wrap(~ year)+
  ggtitle(expression(paste("Spatial distribution of ", italic("Solea solea"), " density by year from the CGFS campaign")))
```

\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Scatter plot of density by year

ggplot(sp_data_CGFS_density, aes(x = factor(year), y = densityKgKm2)) +
  geom_point()+
  theme_minimal() +
  labs(x = "Years", y = "Density (kg/km²)")+
  ggtitle(expression(paste("Density of ", italic("Solea solea"), " per haul across years")))

```

<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Histogram of density by year

ggplot(sp_data_CGFS_density, aes(x = densityKgKm2)) +
  geom_histogram()+
  facet_wrap(~year)+
  labs(x = "Density (kg/km²)", y= "Number of hauls") +
  theme_minimal()+
  theme(strip.background = element_rect(color = "black", fill = "grey90"))+
  ggtitle(expression(paste("Frequency distribution of ", italic("Solea solea"), " density per year")))

```

<br>
<br>
\vspace{2cm}

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Column plot of total density by year

ggplot(sp_data_CGFS_density, aes(x = factor(year), y=densityKgKm2)) + 
  geom_col() +
  labs(y = "Density (kg/km²)", x = "Years") +
  ggtitle(expression(paste("Total density of ", italic("Solea solea"), " from CGFS hauls per year")))+
  theme_minimal()

```




### BATHYMETRY

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Load the bathymetry raster from a NetCDF file
bathy_emod <- raster(here("01_DATA", "E4_2024.nc", "E4_2024.nc"), varname ="elevation")

# Plot the bathymetry
plot(bathy_emod, main = "Bathymetry EMOD 2024", col = terrain.colors(100))

# Define the bounding box coordinates: xmin, xmax, ymin, ymax
bbox <- c(-1.9, 2.5, 49.2, 51.4)

```

```{r echo=FALSE, fig.height=6, fig.width=10, message=FALSE, warning=FALSE, paged.print=TRUE}

# Define the bounding box coordinates: xmin, xmax, ymin, ymax
bbox <- c(-1.9, 2.5, 49.2, 51.4)

# Create an extent object from the bounding box
bbox_extent <- extent(bbox)

# Crop the raster to the defined extent
bathy_crop <- crop(bathy_emod, bbox_extent)

# Plot the cropped bathymetry
plot(bathy_crop, main = "Bathymetry of Eastern English Channel", col = terrain.colors(100))


```


